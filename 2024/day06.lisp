(in-package #:advent-of-code-2024.day06)

(defun parse-input (input)
  (util:parse-string-into-array input))

(defun rotate-right (delta)
  (destructuring-bind (dr dc) delta
    (list (+ (* 0 dr) (* 1 dc))
          (+ (* -1 dr) (* 0 dc)))))
#+(or)
(rotate-right '(-1 0))
#+(or)
(rotate-right '(0 1))
#+(or)
(rotate-right '(1 0))
#+(or)
(rotate-right '(0 -1))

(defun locate-starting-point (arr)
  (loop
    for row from 0 below (array-dimension arr 0)
    do (loop
         for col from 0 below (array-dimension arr 1)
         when (char= #\^ (aref arr row col))
           do (return-from locate-starting-point (list row col)))))

(defun add-delta (pos delta)
  (mapcar #'+ pos delta))

(defun problem-1 (&key (input *input-part-1-test*))
  (let* ((arr (parse-input input))
         (visited (make-hash-table :test #'equal))
         (delta '(-1 0)) ; facing up
         (position (locate-starting-point arr)))
    
    (loop
      with delta = delta
      for pos = position then (add-delta pos delta)
      do (setf (gethash pos visited) t)
      until (not (apply #'array-in-bounds-p arr (add-delta pos delta)))
      if (char= #\# (apply #'aref arr (add-delta pos delta)))
        do (setf delta (rotate-right delta)))
    (hash-table-count visited)))

(defun get-rotation-points (ht)
  (loop
    for pos being the hash-keys in ht using (hash-value v)
    if (eql v :rotation)
      collect pos))

(defun get-obstacles (ht)
  (loop
    for pos being the hash-keys in ht using (hash-value v)
    if (eql v :obstacle)
      collect pos))

(defun find-collisions (p1 p2 p3 obstacles)
  (let* ((rowmin (min (car p1) (car p2) (car p3)))
         (rowmax (max (car p1) (car p2) (car p3)))
         (colmin (min (cadr p1) (cadr p2) (cadr p3)))
         (colmax (max (cadr p1) (cadr p2) (cadr p3))))
    (find-if (lambda (p)
               (and (< rowmin (car p) rowmax)
                    (< colmin (cadr p) colmax)))
             obstacles)))

(defun incomplete-rectangle? (p1 p2 p3 obstacles)
  (and
   (or (and (= (first p1) (first p2))
            (= (second p2) (second p3)))
       (and (= (second p1) (second p2))
            (= (first p2) (first p3))))
   (not (find-collisions p1 p2 p3 obstacles))))

(defun find-incomplete-rectangles (points obstacles)
  (loop
    for (p1 . r1) on points
    sum (loop
          for (p2 . r2) on r1
          sum (loop
                for (p3 . r3) on r2
                if (incomplete-rectangle? p1 p2 p3 obstacles)
                  count 1))))

(defun problem-2 (&key (input *input-part-1-test*))
  (let* ((arr (parse-input input))
         (visited (make-hash-table :test #'equal))
         (delta '(-1 0)) ; facing up
         (position (locate-starting-point arr)))
    
    (loop
      with delta = delta
      for pos = position then (add-delta pos delta)
      do (setf (gethash pos visited) t)
      until (not (apply #'array-in-bounds-p arr (add-delta pos delta)))
      if (char= #\# (apply #'aref arr (add-delta pos delta)))
        do (progn (setf (gethash (add-delta pos delta) visited) :obstacle)
                  (setf delta (rotate-right delta))
                  (setf (gethash pos visited) :rotation)))
    (find-incomplete-rectangles
     (get-rotation-points visited)
     (get-obstacles visited))))

(defparameter *input-part-1-test*
  "....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...")

(defparameter *input-part-2-test*
  *input-part-1-test*)

(defparameter *input*
  "..#.....................#............#....#...........#...............................#.....#.....................................
.................#............................#.............##..#...............................#....#..#.........#...............
.............................................##.........................................#....................#...............#...#
...##....................#...............#.....#....................#......##..............#............................#....#....
.................................#..#..............#...........#.............#..#........................#............#...........
.................#.........................#...........................#........................#........................#........
...#....................................#....#.........#................#...............#.....#................#.....#............
.............#.#..........................................................#...#..................#....#.......#.....#...#.........
.....#........................#....##...#............................................................#............................
..................#...#.........................................#..................#.............................#.#........#.....
......#...............................#.#..........##..#...........#.........................#.......#....................#.......
.................................#..............#...............#........#..........#.........#............#.........#.......#...#
..#..#............#...#.....................#...............#............#.#........................#........#...............#....
..............#..#.#........................#.........#...........##.......#..........#.....................#..............#...#..
..........................#.................##...................................#....#.........#.................................
..................#..#........#....#...............#..............#.......#.......#......................................#..#...#.
..........#.#.................#.........#...................#.......................##......#....................#.......#........
..........#.........#...#......................................................................#.....#............#........#......
...##.............#...........................................................#..#....................##.#...#.#..#.........#..#..
.....#......#.............................#.......#...#...#...............#.....#............#........#..#.#......................
........#................#.........#.......................................................................#..........#...........
.......#........................................#..........#...............................#..#...................................
..................##.......#.......#.....#............#.......#...#.........#....##...............#..#.............#..........#...
.......#...........#...........#...........................#.............#.........#..#........................#.##...............
.....................................................................#........#....#...........................................#..
....#...........#......#.........#....................................#.................................#......#..................
...#........................................#..#...............................#.....................#.#......#...................
..#.....#.................................#.................#....#............................................#......#............
...................................................##...........#.......#.............#.................#.......#.................
..........................................................##..............#....#....#.............#...............................
........................................................#.....................................#................................#..
..............##....#..#..........#...........#......#..#....#.......#................#............................#..#...#.......
..........................#....................#.................................................#................................
#................................................#.....................#..#...............##........#...#...#.........#...........
...........#.................................#..#....................#.#.......#..........................#.......#.......#.......
..............................#......#......#.................#.................#.................#.#.............#..#.#..........
.......................#....................#....................................#.....#.#.......#............................#...
...............................................................................................#.#................................
#..................#.....#...............................#..............#...#.....................................................
..........................................................#.................................................#.....................
..........#.........................#.....................................................#.........#..........#................#.
........#..............#..#......................................#.........#............#.................................#.......
.......#.........................................................#.........#................#...............................#.....
...........#............................................#...#.............................#.....^................................#
................#.............#...#..............................#..................................#.............................
.........................................................................................................#........................
.................................................#........#.......................#.#.....#......................#................
.........#.........#...#....................................................#.....................................................
##.##..#...................................#......................................................................................
.................#...........................................................................................#........#...........
.........................................................................#........................#....#......................#...
..............#......................#........#..........................#.........#..............................................
.......................#............................................................................##............................
.....#.................#........#...#...............#.............................#......................#........................
....#...................................................................................#............##...........................
................#............................#............................................#.......................................
.......................................................................................................#......#...................
......................................................................................#...#.......................................
...............................................#........#..........#............................#..............#.......#..........
..............#.....................#........#..#............................#...#..#.#...................................#.......
..........#...............................#............................#...........................................#..............
....#............#.#....#......................................................................#..................................
.......................#.......................#................................#..............#.....................#.........#..
...........#.........................#.............#.#........#........#..........................................#...............
.......#......................#....................#...............................#......................#...........#...........
............#.....................................................................................................................
....#.......#............................................................#.........#.............#..........#....#..........#.....
.......#.........................................................................#..................#..#....#.......#.............
............................#....#.......#......#.......#.....................#.................#.................................
.......................................................#.............#..........................#.................................
....................................#.....................................##......................#............................#..
..............#...............#....................#.......................#................#......................#..............
....................#...........................#...................................................................#.............
...#..........................#...........................#............................................................#..........
..............#.................#.............................#..#.......#.......................#.##.............................
....................#.....#...#..............................................#......#...........#.................#..#....#.......
#......................................#.....................#..#..#.#...........#.............#.................................#
.....................#...........................................................#..........#............##..........#............
.......#..................................#...............#..........#....#...................................................#...
.............#.................#...........................#..............#.................................................#.....
...............................#......................................##...................................#.#......#..........#..
.................##....................#.................................................#......................#................#
........#....................................#..........#.........................#..................#......................#.....
...#....#...........................#..............................#.#..........................#.................................
.#...................................#..#......#.................................................................#................
.................................#...........#................#.#........................#....................................##..
#..#.....##...............#................................................................#....#......#.........................#
.#....#......................................................#.........................#.......................................#..
.#..............................................#.................................................................#...............
...............#..........................................#...#...............................#.#..#.#........#...................
..............#................................#.......#..................................#.........................#........#....
.......................##..................................................#......................................................
..............................#...............................##..................................................................
#....................#...........................................................#.............................#..................
#..................................................................#...#..........................................................
#..#........#...................................#..#..........##..............#...................................................
.......................#.....................#....................................................................................
.....................#...........#.............................................................#........................#....#....
...............#............................................................................##...#..........................#.....
...#......................................#.......................................................................................
....#...........................#.........#.................................................#..........#...#........#....#........
......#....#.#............................#..........................................#........................................#...
...........#...#.............................................#......................#..................#.....................#....
...#..........#........#..........#.......#..............#.............................#.......................#................#.
...........#...............#...........................................................#..........................................
..#..........##.................................................#...#...............#.......................#...............##....
.......................#..............#.............#......................................................#..................#...
..............#..#........##..........#...................................................#.............##....................#...
...................#..................................................#................#......#.....#.........#.#...#.............
..................#.................................................#.................................................#.........#.
......................................#.#........#.....#...#..........#..............#.........................#...#..............
.................................#..............#..#.....................#................#.............#..#..#...................
.........#.......#.#..............#..#...............#.................#..................................#..#....................
.............................#....#.......##..................................................................................##..
.....................................................................................#........#.......#......#....................
........#...........#..........#..........#............................#...............#........#.#...........................#...
.#.................#...#..............#...#...................#........#...............#..........................................
.........#............................................##........#......#.....................#.......................#............
.......................................#..........#..#......#........#..........#..........................#....................#.
....#......#..........................#....................#.......................................#.....###.......#..............
.......#..................#....#.......................................................................#..........................
....#........................#.............................................................#.......#..........................#...
......................#.................................#..........#................#..#.........................#................
...........#....................................................#..............#...........................#......................
.....#................#........#...#....#........#............#...............#.......................#..#.........#..............
#..................................................#...........................#....#...........#.................................
....#.#.....................................#.#...............#................#....................................#.............
............#....................#.#.#...............................................#...................##.......................
...##..............#........................#.............#.......#...........#.#.##..............................#....##.........
......#...........#....................................................#.........................##...............................")
